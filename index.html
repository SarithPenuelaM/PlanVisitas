<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan de Visitas ‚Äì Versi√≥n con Base de Datos Gratuita (Supabase)</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root{ --bg:#fff; --panel:#f8fafc; --muted:#6b7280; --text:#0b1e2e; --accent:#2563eb; --accent-2:#06b6d4; --danger:#ef4444; --border:#e5e7eb }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Inter,system-ui,sans-serif}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:14px}
    .brand img{height:40px}
    .subtitle{font-size:12px;color:#334155}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button,select,input,textarea{border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--text)}
    button{padding:10px 12px;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn-secondary{background:var(--accent-2);color:#fff;border-color:var(--accent-2)}
    .btn-ghost{background:#fff}
    .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:16px}
    .filters{display:flex;gap:10px;align-items:end;flex-wrap:wrap}
    .filters .field{min-width:200px}
    .kpi-row{display:flex;gap:8px;align-items:stretch;overflow:auto;white-space:nowrap;padding:2px}
    .kpi{background:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;display:flex;gap:6px;align-items:center;font-size:12px}
    .kpi b{font-size:12px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f1f5f9}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;display:inline-block;border:1px solid transparent}
    .status-Pendiente{background:#fff7ed;color:#c2410c;border-color:#fed7aa}
    .status-Confirmado{background:#ecfeff;color:#0e7490;border-color:#a5f3fc}
    .status-Reprogramado{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe}
    .status-Cancelado{background:#fef2f2;color:#b91c1c;border-color:#fecaca}
    #calendar{background:#fff;border:1px solid var(--border);border-radius:16px;padding:10px;min-height:480px}
    dialog{border:none;border-radius:14px;max-width:720px;width:96%;padding:0}
    .modal{padding:16px}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin:0 0 8px}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    @media (max-width:720px){.grid-2{grid-template-columns:1fr}}
    label{font-size:12px;color:#334155;display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px}
    .chart-sm{height:220px;max-height:220px}
    @media (max-width:720px){.chart-sm{height:200px;max-height:200px}}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .muted{color:var(--muted);font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;display:none;max-width:420px;background:#111827;color:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:1000}
    .toast.show{display:block}
    .toast .title{font-weight:700;margin-bottom:4px}
    .toast .body{font-size:12px;opacity:.9}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <img alt="Entelgy" src="Logo-Entelgy.png"/>
        <div>
          <h1>Plan de Visitas a Clientes</h1>
          <div class="subtitle">Entelgy ¬∑ Human driven technology ¬∑ Colombia</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnGoDashboard" class="btn-secondary">üìä Dashboard</button>
        <button id="btnNew" style="display:none">‚ûï Nueva visita</button>
        <button id="btnExport" class="btn-primary" style="display:none">‚¨áÔ∏è Exportar CSV</button>
        <button id="btnImport" class="btn-ghost" style="display:none">‚¨ÜÔ∏è Importar CSV</button>
        <input type="file" id="fileInput" accept=".csv" style="display:none" />
        <button id="btnPrint" class="btn-ghost" style="display:none">üñ®Ô∏è Imprimir</button>
        <!-- Bot√≥n Borrar todo desactivado y oculto -->
        <button id="btnClearAll" class="btn-danger" style="display:none" disabled>üóëÔ∏è Borrar todo</button>
      </div>
    </header>

    <!-- Filtros globales (siempre visibles) -->
    <section class="card" id="globalFiltersSection">
      <div class="filters">
        <div class="field">
          <label for="filterDesde">Desde</label>
          <input id="filterDesde" type="date">
        </div>
        <div class="field">
          <label for="filterHasta">Hasta</label>
          <input id="filterHasta" type="date">
        </div>
        <div class="field">
          <label for="filterPM">PM Responsable</label>
          <select id="filterPM">
            <option value="">Todos</option>
            <option value="luisa.bello@entelgy.com">Luisa Fernanda Bello Vargas</option>
            <option value="mariaf.llanes@entelgy.com">Maria Fernanda Llanes Ferreira</option>
            <option value="carolina.torres@entelgy.com">Carolina Torres Jimenez</option>
            <option value="eduar.hernandez@entelgy.com">Eduar Yovani Hernandez Ruiz</option>
            <option value="sarith.penuela@entelgy.com">Sarith Mayerly Pe√±uela Morales</option>
            <option value="john.lamus@entelgy.com">John David Lamus Cardona</option>
            <option value="gisela.vela@entelgy.com">Ruth Yisela Vela Leon</option>
          </select>
        </div>
        <div class="field">
          <label for="filterCliente">Cliente</label>
          <input id="filterCliente" placeholder="Nombre cliente" />
        </div>
        <div class="field">
          <label for="filterEstado">Estado</label>
          <select id="filterEstado">
            <option value="">Todos</option>
            <option>Pendiente</option>
            <option>Confirmado</option>
            <option>Reprogramado</option>
            <option>Cancelado</option>
          </select>
        </div>
        <div class="field">
          <button id="btnApplyFilters" class="btn-secondary">Aplicar filtros</button>
        </div>
        <div class="field">
          <button id="btnClearFilters" class="btn-ghost">Limpiar</button>
        </div>
      </div>
    </section>

    <!-- Dashboard (acorde√≥n) -->
    <section class="card" id="dashboardSection" style="display:none">
      <h2>Dashboard de Visitas</h2>
      <div class="kpi-row" id="kpiRow" style="margin-top:8px">
        <div class="kpi"><b>Total:</b><span id="k_total">‚Äî</span></div>
        <div class="kpi"><b>Confirmadas:</b><span id="k_conf">‚Äî</span></div>
        <div class="kpi"><b>Pendientes:</b><span id="k_pend">‚Äî</span></div>
        <div class="kpi"><b>% Confirmaci√≥n:</b><span id="k_rate">‚Äî</span></div>
        <div class="kpi"><b>Top Clientes:</b><span id="k_top_clients">‚Äî</span></div>
      </div>
      <div class="grid grid-2" style="margin-top:10px">
        <canvas id="chartEstado" class="chart-sm"></canvas>
        <canvas id="chartCliente" class="chart-sm"></canvas>
      </div>
    </section>

    <!-- Calendario -->
    <section class="card" id="calendarSection">
      <h2>Calendario de Visitas</h2>
      <div id="calendar"></div>
    </section>

    <!-- Listado -->
    <section class="card">
      <h2>Listado de Visitas</h2>
      <table id="visitsTable">
        <thead>
          <tr>
            <th>Cliente</th><th>Fecha</th><th>Hora</th><th>Objetivo</th><th>PM Responsable</th><th>Estado</th>
          </tr>
        </thead>
        <tbody id="visitsBody"></tbody>
      </table>
    </section>
  </div>

  <!-- Modal -->
  <dialog id="visitDialog">
    <form id="visitForm" method="dialog" class="modal">
      <header>
        <strong id="dlgTitle">Nueva visita</strong>
        <button type="button" id="dlgClose" class="btn-ghost">‚úñ</button>
      </header>
      <div class="grid grid-2">
        <div>
          <label for="cliente">Cliente *</label>
          <input id="cliente" required placeholder="Ej. Davivienda" />
        </div>
        <div>
          <label for="objetivo">Objetivo</label>
          <input id="objetivo" placeholder="Demo, seguimiento‚Ä¶" />
        </div>
        <div>
          <label for="fecha">Fecha *</label>
          <input id="fecha" type="date" required />
        </div>
        <div>
          <label for="hora">Hora</label>
          <input id="hora" type="time" />
        </div>
        <div>
          <label for="estado">Estado</label>
          <select id="estado">
            <option>Pendiente</option>
            <option>Confirmado</option>
            <option>Reprogramado</option>
            <option>Cancelado</option>
          </select>
        </div>
        <div>
          <label for="pm">PM Responsable</label>
          <select id="pm">
            <option value="luisa.bello@entelgy.com">Luisa Fernanda Bello Vargas</option>
            <option value="mariaf.llanes@entelgy.com">Maria Fernanda Llanes Ferreira</option>
            <option value="carolina.torres@entelgy.com">Carolina Torres Jimenez</option>
            <option value="eduar.hernandez@entelgy.com">Eduar Yovani Hernandez Ruiz</option>
            <option value="sarith.penuela@entelgy.com">Sarith Mayerly Pe√±uela Morales</option>
            <option value="john.lamus@entelgy.com">John David Lamus Cardona</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button class="btn-primary" id="btnSave" value="default">Guardar</button>
        <button class="btn-ghost" id="btnCancel" value="cancel">Cancelar</button>
      </div>
    </form>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="title" id="toastTitle">Aviso</div>
    <div class="body" id="toastBody">Mensaje</div>
  </div>

  <script>
    // ====== CONFIG Supabase ======
    const SUPABASE_URL = "https://dbnlqslrmuqyqptuthem.supabase.co"; // conexi√≥n directa
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRibmxxc2xybXVxeXFwdHV0aGVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNDI2NjEsImV4cCI6MjA3NTcxODY2MX0.u7Zx1z4mxMFPIuCh8PNN4_8bwwGTA0NBMjhQ3W6c52U"; // conexi√≥n directa
    const DB_TABLE = 'visits';
    const STORAGE_KEY = 'plan_visitas_clientes_v1';

    // ====== DOM refs ======
    const visitsBody = document.getElementById('visitsBody');
    const dlg = document.getElementById('visitDialog');
    const form = document.getElementById('visitForm');
    const btnNew = document.getElementById('btnNew');
    const btnClearAll = document.getElementById('btnClearAll');
    const btnSave = document.getElementById('btnSave');
    const dlgClose = document.getElementById('dlgClose');
    const btnGoDashboard = document.getElementById('btnGoDashboard');

    // Filtros visibles
    const fDesde = document.getElementById('filterDesde');
    const fHasta = document.getElementById('filterHasta');
    const fPM = document.getElementById('filterPM');
    const fCliente = document.getElementById('filterCliente');
    const fEstado = document.getElementById('filterEstado');

    // ====== Estado ======
    let state = { rows: [], editIndex: null, filters: { pm:'', estado:'', desde:'', hasta:'', cliente:'' } };
    let calendar; let chartEstado, chartCliente;

    // ====== Identificadores estables para eventos ======
    function ensureClientId(row){
      if(row && !row.id && !row._cid){
        const rid = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : ('cid_'+Math.random().toString(36).slice(2)+Date.now());
        row._cid = 'c_'+rid;
      }
      return row;
    }
    function uidFor(row){ return row ? (row.id || row._cid) : null; }

    // ====== Cliente Supabase ======
    const sb = (SUPABASE_URL && /\.supabase\.co/i.test(SUPABASE_URL) && SUPABASE_ANON && SUPABASE_ANON.length>30)
      ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON)
      : null;

    // ====== Utils ======
    function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');}
    function showToast(title, msg){ const t=document.getElementById('toast'); document.getElementById('toastTitle').textContent=title; document.getElementById('toastBody').textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 4200); }

    // ====== Local fallback ======
    function restoreLocal(){ try{ state.rows = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){ state.rows = []; } }
    function persistLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.rows)); }

    // ====== DB helpers ======
    function buildPayload(row){
      return {
        id: row.id || undefined,
        cliente: String(row.cliente||'').trim(),
        objetivo: row.objetivo ? String(row.objetivo).trim() : null,
        fecha: String(row.fecha||'').slice(0,10),
        hora: row.hora ? String(row.hora).slice(0,5) : null,
        estado: row.estado || 'Pendiente',
        pm_name: row.pmName ? String(row.pmName).trim() : null,
        pm_email: row.pmEmail ? String(row.pmEmail).trim() : null
      };
    }

    function validateRowForDB(row){
      const errors=[];
      if(!row.cliente || !String(row.cliente).trim()) errors.push('cliente es requerido');
      if(!row.fecha || !/^\d{4}-\d{2}-\d{2}$/.test(row.fecha)) errors.push('fecha v√°lida es requerida (YYYY-MM-DD)');
      if(!row.estado) errors.push('estado es requerido');
      return { ok: errors.length===0, errors };
    }

    async function loadFromDB(){
      if(!sb) { restoreLocal(); return; }
      const { data, error } = await sb.from(DB_TABLE)
        .select('*')
        .order('fecha', { ascending:true })
        .order('hora', { ascending:true, nullsFirst:true });
      if(error){ console.warn('DB load error, usando localStorage', error); showToast('BD (lectura)', 'No fue posible leer desde Supabase. Se usa almacenamiento local.'); restoreLocal(); return; }
      state.rows = (data||[]).map(r=>ensureClientId({ id:r.id, cliente:r.cliente, objetivo:r.objetivo, fecha:r.fecha, hora:r.hora||'', estado:r.estado, pmName:r.pm_name, pmEmail:r.pm_email }));
      persistLocal();
    }

    async function upsertToDB(row){
      if(!sb) return { ok:false, error:{ message:'Supabase desactivado' } };
      const payload = buildPayload(row);
      const v = validateRowForDB(payload);
      if(!v.ok){
        const msg='Validaci√≥n fall√≥: '+v.errors.join(', ');
        console.warn(msg, payload);
        showToast('Datos incompletos', msg);
        return { ok:false, error:{ message: msg } };
      }
      try{
        const { data, error } = await sb.from(DB_TABLE).upsert(payload).select().single();
        if(error){
          console.error('DB upsert error', error);
          let hint = 'Revisa RLS/Policies y columnas requeridas en la tabla.';
          if(/invalid input value/.test(String(error.message||''))) hint = 'Formato de dato inv√°lido para una columna.';
          if(/permission denied|RLS/.test(String(error.message||''))) hint = 'Pol√≠ticas RLS bloquean la escritura. Ajusta RLS o usa service_role (no en frontend).';
          showToast('BD (escritura)', 'No se pudo guardar en Supabase. '+hint);
          return { ok:false, error };
        }
        row.id = data.id;
        return { ok:true, data };
      }catch(ex){
        console.error('DB upsert ex', ex);
        showToast('BD (excepci√≥n)', 'Fallo al guardar. Revisa conexi√≥n y credenciales.');
        return { ok:false, error: ex };
      }
    }

    // ====== Protecci√≥n: deleteAllDB desactivado (bot√≥n oculto) ======
    function deleteAllDB(){
      console.warn('Funci√≥n deleteAllDB desactivada por seguridad.');
      showToast('Acci√≥n no permitida','El borrado total de registros est√° deshabilitado.');
    }

    // ====== Filtros ======
    function applyFiltersFromGlobal(){
      state.filters.desde   = fDesde.value || '';
      state.filters.hasta   = fHasta.value || '';
      state.filters.pm      = fPM.value || '';
      state.filters.cliente = fCliente.value || '';
      state.filters.estado  = fEstado.value || '';
    }

    function getFilteredRows(){
      var pm = state.filters.pm, estado = state.filters.estado, desde = state.filters.desde, hasta = state.filters.hasta, cliente = state.filters.cliente;
      return state.rows.filter(function(r){
        var ok = true;
        if(pm) ok = ok && (r.pmEmail === pm);
        if(estado) ok = ok && r.estado === estado;
        if(desde) ok = ok && r.fecha >= desde;
        if(hasta) ok = ok && r.fecha <= hasta;
        if(cliente) ok = ok && String(r.cliente||'').toLowerCase().indexOf(cliente.toLowerCase()) !== -1;
        return ok;
      }).sort(function(a,b){ return (a.fecha + (a.hora||'')) > (b.fecha + (b.hora||'')) ? 1 : -1; });
    }

    // ====== Render tabla ======
    function renderTable(){
      const rows = getFilteredRows();
      visitsBody.innerHTML='';
      rows.forEach(function(r){
        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+escapeHtml(r.cliente)+'</td>'+
                     '<td>'+r.fecha+'</td>'+
                     '<td>'+String(r.hora||'').slice(0,5)+'</td>'+
                     '<td>'+escapeHtml(r.objetivo||'')+'</td>'+
                     '<td>'+escapeHtml(r.pmName||'')+'</td>'+
                     '<td><span class="badge status-'+r.estado+'">'+r.estado+'</span></td>';
        visitsBody.appendChild(tr);
      });
    }

    // ====== Calendario ======
    function renderCalendar(){
      const el = document.getElementById('calendar');
      if(!el) return;
      if(calendar && calendar.destroy) calendar.destroy();
      calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        locale: 'es',
        selectable: true,
        headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
        dateClick: function(info){ openDialog({ fecha: info.dateStr }); },
        eventClick: function(info){
          const uid = info.event.extendedProps && info.event.extendedProps.uid;
          const idx = state.rows.findIndex(function(x){ return uidFor(x) === uid; });
          if (idx > -1) { openDialog(state.rows[idx], idx); }
        },
        events: []
      });
      calendar.render();
      addEventsFromState();
    }

    function addEventsFromState(){
      if(!calendar) return;
      const rows = getFilteredRows();
      calendar.removeAllEvents();
      rows.forEach(function(r){
        ensureClientId(r);
        const uid = uidFor(r);
        calendar.addEvent({
          title: r.cliente + (r.objetivo ? ' - ' + r.objetivo : '') + (r.pmName ? ' (' + r.pmName + ')' : ''),
          start: r.fecha + (r.hora ? 'T' + r.hora : ''),
          allDay: !r.hora,
          extendedProps: { uid: uid }
        });
      });
    }
    function rerenderCalendar(){ addEventsFromState(); }

    // ====== Dashboard ======
    async function fetchDashboardData(filters){
      filters = filters || {};
      if(sb){
        let q = sb.from(DB_TABLE).select('cliente,estado,pm_name,pm_email,fecha');
        if(filters.desde) q=q.gte('fecha',filters.desde);
        if(filters.hasta) q=q.lte('fecha',filters.hasta);
        if(filters.pm) q=q.eq('pm_email',filters.pm);
        if(filters.estado) q=q.eq('estado',filters.estado);
        if(filters.cliente) q=q.ilike('cliente','%'+filters.cliente+'%');
        const {data,error}=await q;
        if(error){ console.warn('DB dash error', error); showToast('BD (dashboard)','No se pudo consultar datos.'); return getFilteredRows(); }
        return data||[];
      }
      return getFilteredRows();
    }

    function computeKPIs(rows){
      const total=rows.length;
      const byEstado=rows.reduce(function(a,r){a[r.estado]=(a[r.estado]||0)+1;return a;},{});
      const conf=byEstado['Confirmado']||0;
      const pend=byEstado['Pendiente']||0;
      const rate=total?Math.round(conf*100/total):0;
      const byCliente=rows.reduce(function(a,r){const k=r.cliente||'(sin cliente)'; a[k]=(a[k]||0)+1; return a;},{});
      const topClients=Object.entries(byCliente).sort(function(a,b){return b[1]-a[1];}).slice(0,3).map(function(x){return x[0]+' ('+x[1]+')';}).join(', ')||'‚Äî';
      return { total, conf, pend, rate, byEstado, byCliente, topClients };
    }

    function renderKPIs(k){
      document.getElementById('k_total').textContent=k.total;
      document.getElementById('k_conf').textContent=k.conf;
      document.getElementById('k_pend').textContent=k.pend;
      document.getElementById('k_rate').textContent=k.rate+'%';
      document.getElementById('k_top_clients').textContent=k.topClients;
    }

    function renderCharts(k){
      const estados=['Pendiente','Confirmado','Reprogramado','Cancelado'];
      const bgColors=['#fff7ed','#ecfeff','#eff6ff','#fef2f2'];
      const brColors=['#c2410c','#0e7490','#1d4ed8','#b91c1c'];
      const dataEstado = estados.map(function(e){ return k.byEstado[e]||0; });
      if(chartEstado && chartEstado.destroy) chartEstado.destroy();
      var ctxEstado = document.getElementById('chartEstado');
      if(!ctxEstado){ console.warn('No se encontr√≥ #chartEstado'); return; }
      chartEstado = new Chart(ctxEstado.getContext('2d'),{
        type:'bar',
        data:{ labels:estados, datasets:[{ label:'Visitas', data:dataEstado, backgroundColor:bgColors, borderColor:brColors, borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
      var cLabels = Object.keys(k.byCliente);
      var cValues = cLabels.map(function(l){ return k.byCliente[l]; });
      if(cLabels.length === 0){ cLabels = ['Sin datos']; cValues = [1]; }
      if(chartCliente && chartCliente.destroy) chartCliente.destroy();
      var ctxCliente = document.getElementById('chartCliente');
      if(!ctxCliente){ console.warn('No se encontr√≥ #chartCliente'); return; }
      chartCliente = new Chart(ctxCliente.getContext('2d'),{ type:'doughnut', data:{ labels:cLabels, datasets:[{ label:'Por cliente', data:cValues }] }, options:{ responsive:true, maintainAspectRatio:false } });
      if(chartCliente && chartCliente.update) chartCliente.update();
    }

    function ensureChartsSized(){
      try{ if(chartEstado && chartEstado.resize) chartEstado.resize(); if(chartCliente && chartCliente.resize) chartCliente.resize(); }catch(_){ }
    }

    async function refreshDashboard(){
      const filters = { desde:fDesde.value||null, hasta:fHasta.value||null, pm:fPM.value||null, cliente:fCliente.value||'', estado:fEstado.value||null };
      const data = await fetchDashboardData(filters);
      const k = computeKPIs(data);
      renderKPIs(k); renderCharts(k); renderTable(); rerenderCalendar();
    }

    // ====== Modal ======
    function openDialog(data, index){
      data=data||{}; index=(typeof index==='number')?index:null; state.editIndex=index;
      document.getElementById('dlgTitle').textContent = index==null ? 'Nueva visita' : 'Editar visita';
      document.getElementById('cliente').value=data.cliente||'';
      document.getElementById('objetivo').value=data.objetivo||'';
      document.getElementById('fecha').value=data.fecha||'';
      document.getElementById('hora').value=String(data.hora||'').slice(0,5);
      document.getElementById('estado').value=data.estado||'Pendiente';
      const pmSel=document.getElementById('pm');
      if(data.pmEmail){ pmSel.value=data.pmEmail; } else { pmSel.selectedIndex=0; }
      dlg.showModal();
    }
    function closeDialog(){ dlg.close(); form.reset(); state.editIndex=null; }

    // ====== Eventos UI ======
    document.getElementById('btnApplyFilters').addEventListener('click', function(e){ e.preventDefault(); applyFiltersFromGlobal(); refreshDashboard(); });
    document.getElementById('btnClearFilters').addEventListener('click', function(e){ e.preventDefault(); ['filterDesde','filterHasta','filterPM','filterCliente','filterEstado'].forEach(function(id){ var el=document.getElementById(id); if(el){ el.value=''; }}); applyFiltersFromGlobal(); refreshDashboard(); });
    document.getElementById('btnCancel').addEventListener('click', closeDialog);
    document.getElementById('dlgClose').addEventListener('click', closeDialog);
    btnNew.addEventListener('click', function(){ openDialog(); });
    btnClearAll.addEventListener('click', function(){ deleteAllDB(); });

    function toggleDashboard(){
      const dash = document.getElementById('dashboardSection');
      const isOpen = dash.style.display !== 'none';
      if (isOpen) { dash.style.display = 'none'; }
      else { dash.style.display = 'block'; refreshDashboard(); setTimeout(ensureChartsSized, 0); }
      setTimeout(function(){ if(calendar){ calendar.updateSize(); } }, 0);
    }
    btnGoDashboard.addEventListener('click', function(){ toggleDashboard(); });

    // ====== Guardar visita ======
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      const pmSel = document.getElementById('pm');
      const base = state.editIndex==null ? {} : state.rows[state.editIndex];
      const row = { id: base.id, cliente:String(document.getElementById('cliente').value||'').trim(), objetivo:String(document.getElementById('objetivo').value||'').trim(), fecha:document.getElementById('fecha').value, hora:document.getElementById('hora').value, estado:document.getElementById('estado').value, pmName: pmSel.options[pmSel.selectedIndex] ? pmSel.options[pmSel.selectedIndex].text : '', pmEmail: pmSel.value };
      if(!row.cliente || !row.fecha){ alert('Completa Cliente y Fecha'); return; }
      var d=new Date(); var todayLocal = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
      if(row.fecha < todayLocal){ alert('No se permiten visitas en fechas anteriores a hoy.'); return; }
      const res = await upsertToDB(row);
      if(!res.ok){ console.warn('Fallo de upsert; se guarda localmente.'); }
      ensureClientId(row);
      if(state.editIndex==null){ state.rows.push(row); } else { state.rows[state.editIndex]=row; }
      persistLocal(); renderTable(); rerenderCalendar(); closeDialog();
    });

    // ====== Inicio ======
    (async function init(){
      await loadFromDB();
      const now=new Date(); const y=now.getFullYear(); const m=now.getMonth();
      function toISO(d){ return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().slice(0,10); }
      fDesde.value = toISO(new Date(y,m,1));
      fHasta.value = toISO(new Date(y,m+1,0));
      var dmin = y+'-'+String(m+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');
      var fFecha=document.getElementById('fecha'); if(fFecha){ fFecha.setAttribute('min', dmin); }
      applyFiltersFromGlobal(); renderTable(); renderCalendar(); setTimeout(function(){ if(calendar){ calendar.updateSize(); } }, 0);
    })();

    // ====== Autotests m√≠nimos ======
    (function selfTests(){ try{
      console.assert(!!document.querySelector('#calendarSection h2'),'Debe existir t√≠tulo calendario');
      console.assert(typeof FullCalendar!=='undefined','FullCalendar cargado');
      console.assert(typeof Chart!=='undefined','Chart.js cargado');
      (function(){ var r={cliente:'ACME',fecha:'2025-10-01',estado:'Pendiente'}; var v=validateRowForDB(r); console.assert(v.ok,'Validaci√≥n deber√≠a pasar'); var r2={cliente:'',fecha:'',estado:''}; var v2=validateRowForDB(r2); console.assert(!v2.ok && v2.errors.length>=2,'Validaci√≥n deber√≠a fallar'); })();
      console.log('[SelfTest] OK');
    }catch(e){ console.warn('[SelfTest] Problemas:', e); } })();
  </script>
</body>
</html>
