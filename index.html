<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan de Visitas a Clientes ‚Äì Entelgy (con BD gratuita)</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --bg:#ffffff; --panel:#f8fafc; --muted:#6b7280; --text:#0b1e2e; --accent:#2563eb; --accent-2:#06b6d4; --danger:#ef4444; --border:#e5e7eb }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Inter,system-ui,sans-serif}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:14px}
    .brand img{height:40px}
    .subtitle{font-size:12px;color:#334155}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button,select,input,textarea{border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--text)}
    button{padding:10px 12px;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn-secondary{background:var(--accent-2);color:#fff;border-color:var(--accent-2)}
    .btn-ghost{background:#fff}
    .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:16px}
    .filters{display:flex;gap:10px;align-items:end;flex-wrap:wrap}
    .filters .field{min-width:220px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f1f5f9}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;display:inline-block;border:1px solid transparent}
    .status-Pendiente{background:#fff7ed;color:#c2410c;border-color:#fed7aa}
    .status-Confirmado{background:#ecfeff;color:#0e7490;border-color:#a5f3fc}
    .status-Reprogramado{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe}
    .status-Cancelado{background:#fef2f2;color:#b91c1c;border-color:#fecaca}
    #calendar{background:#fff;border:1px solid var(--border);border-radius:16px;padding:10px}
    dialog{border:none;border-radius:14px;max-width:720px;width:96%;padding:0}
    .modal{padding:16px}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin:0 0 8px}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    @media (max-width:720px){.grid-2{grid-template-columns:1fr}}
    label{font-size:12px;color:#334155;display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .muted{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <img alt="Entelgy" src="Logo-Entelgy.png"/>
        <div>
          <h1>Plan de Visitas a Clientes</h1>
          <div class="subtitle">Entelgy ¬∑ Human driven technology ¬∑ Colombia</div>
          <div class="muted">Versi√≥n conectada a una base de datos gratuita (Supabase Free Tier)</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnNew" class="btn-secondary">‚ûï Nueva visita</button>
        <button id="btnExport" class="btn-primary">‚¨áÔ∏è Exportar CSV</button>
        <button id="btnImport" class="btn-ghost">‚¨ÜÔ∏è Importar CSV</button>
        <input type="file" id="fileInput" accept=".csv" style="display:none" />
        <button id="btnPrint" class="btn-ghost">üñ®Ô∏è Imprimir</button>
        <button id="btnClearAll" class="btn-danger">üóëÔ∏è Borrar todo</button>
      </div>
    </header>

    <section class="card">
      <div class="filters">
        <div class="field">
          <label for="filterPM">Filtrar por PM Responsable</label>
          <select id="filterPM">
            <option value="">Todos</option>
            <option value="luisa.bello@entelgy.com">Luisa Fernanda Bello Vargas</option>
            <option value="mariaf.llanes@entelgy.com">Maria Fernanda Llanes Ferreira</option>
            <option value="carolina.torres@entelgy.com">Carolina Torres Jimenez</option>
            <option value="eduar.hernandez@entelgy.com">Eduar Yovani Hernandez Ruiz</option>
            <option value="sarith.penuela@entelgy.com">Sarith Mayerly Pe√±uela Morales</option>
            <option value="john.lamus@entelgy.com">John David Lamus Cardona</option>
          </select>
        </div>
        <div class="field">
          <label for="filterEstado">Estado</label>
          <select id="filterEstado">
            <option value="">Todos</option>
            <option>Pendiente</option>
            <option>Confirmado</option>
            <option>Reprogramado</option>
            <option>Cancelado</option>
          </select>
        </div>
        <div class="field">
          <label for="filterDesde">Desde</label>
          <input id="filterDesde" type="date" />
        </div>
        <div class="field">
          <label for="filterHasta">Hasta</label>
          <input id="filterHasta" type="date" />
        </div>
        <div class="field">
          <button id="btnApplyFilters" class="btn-secondary">Aplicar filtros</button>
        </div>
        <div class="field">
          <button id="btnClearFilters" class="btn-ghost">Limpiar</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Calendario de Visitas</h2>
      <div id="calendar"></div>
    </section>

    <section class="card">
      <h2>Listado de Visitas</h2>
      <table id="visitsTable">
        <thead>
          <tr>
            <th>Cliente</th><th>Fecha</th><th>Hora</th><th>Objetivo</th><th>PM Responsable</th><th>Estado</th>
          </tr>
        </thead>
        <tbody id="visitsBody"></tbody>
      </table>
    </section>
  </div>

  <dialog id="visitDialog">
    <form id="visitForm" method="dialog" class="modal">
      <header>
        <strong id="dlgTitle">Nueva visita</strong>
        <button type="button" id="dlgClose" class="btn-ghost">‚úñ</button>
      </header>
      <div class="grid grid-2">
        <div>
          <label for="cliente">Cliente *</label>
          <input id="cliente" required placeholder="Ej. Davivienda" />
        </div>
        <div>
          <label for="objetivo">Objetivo</label>
          <input id="objetivo" placeholder="Demo, seguimiento‚Ä¶" />
        </div>
        <div>
          <label for="fecha">Fecha *</label>
          <input id="fecha" type="date" required />
        </div>
        <div>
          <label for="hora">Hora</label>
          <input id="hora" type="time" />
        </div>
        <div>
          <label for="estado">Estado</label>
          <select id="estado">
            <option>Pendiente</option>
            <option>Confirmado</option>
            <option>Reprogramado</option>
            <option>Cancelado</option>
          </select>
        </div>
        <div>
          <label for="pm">PM Responsable</label>
          <select id="pm">
            <option value="luisa.bello@entelgy.com">Luisa Fernanda Bello Vargas</option>
            <option value="mariaf.llanes@entelgy.com">Maria Fernanda Llanes Ferreira</option>
            <option value="carolina.torres@entelgy.com">Carolina Torres Jimenez</option>
            <option value="eduar.hernandez@entelgy.com">Eduar Yovani Hernandez Ruiz</option>
            <option value="sarith.penuela@entelgy.com">Sarith Mayerly Pe√±uela Morales</option>
            <option value="john.lamus@entelgy.com">John David Lamus Cardona</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button class="btn-primary" id="btnSave" value="default">Guardar</button>
        <button class="btn-ghost" id="btnCancel" value="cancel">Cancelar</button>
      </div>
    </form>
  </dialog>

  <script>
    // ========= CONFIGURA AQU√ç TU PROYECTO SUPABASE =========
    const SUPABASE_URL = "https://dbnlqslrmuqyqptuthem.supabase.co"; // <-- reemplaza
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRibmxxc2xybXVxeXFwdHV0aGVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNDI2NjEsImV4cCI6MjA3NTcxODY2MX0.u7Zx1z4mxMFPIuCh8PNN4_8bwwGTA0NBMjhQ3W6c52U"; // <-- reemplaza
    const STORAGE_KEY = 'plan_visitas_clientes_v1'; // fallback local
    const DB_TABLE = 'visits';
    const visitsBody = document.getElementById('visitsBody');
    const dlg = document.getElementById('visitDialog');
    const form = document.getElementById('visitForm');
    const dlgClose = document.getElementById('dlgClose');
    const btnNew = document.getElementById('btnNew');
    const btnClearAll = document.getElementById('btnClearAll');

    // Filtros UI
    const fPM = document.getElementById('filterPM');
    const fEstado = document.getElementById('filterEstado');
    const fDesde = document.getElementById('filterDesde');
    const fHasta = document.getElementById('filterHasta');

    // Estado
    let state = { rows: [], editIndex: null, filters: {pm:'', estado:'', desde:'', hasta:''} };
    let calendar;

    // Cliente Supabase
    const sb = (SUPABASE_URL && SUPABASE_ANON) ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;

    // ===== Utilidades comunes =====
    function escapeHtml(s){return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;')}
    function csvEsc(v){ if(v==null) return ''; v=String(v).replaceAll('"','""'); return /[",\n]/.test(v)?`"${v}"`:v; }
    function parseCSV(text){ const lines=text.split(/\r?\n/).filter(Boolean); const h=lines.shift().split(','); return lines.map(l=>{const vals=l.match(/\"([^\"]*)\"|[^,]+/g).map(s=>s.replace(/^\"|\"$/g,'')); const o={}; h.forEach((k,i)=>o[k]=vals[i]||''); return o;}); }

    // ===== Persistencia local (fallback sin internet/BD) =====
    function restoreLocal(){ try{ state.rows = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ state.rows = []; } }
    function persistLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.rows)); }

    // ===== Persistencia Supabase =====
    async function loadFromDB(){
      if(!sb) { restoreLocal(); return; }
      const { data, error } = await sb.from(DB_TABLE)
        .select('*')
        .order('fecha', { ascending:true })
        .order('hora', { ascending:true, nullsFirst:true });
      if(error){ console.warn('DB load error, usando localStorage', error); restoreLocal(); return; }
      // Normaliza formato hacia el UI
      state.rows = (data||[]).map(r=>({
        id: r.id,
        cliente: r.cliente,
        objetivo: r.objetivo,
        fecha: r.fecha, // YYYY-MM-DD
        hora: r.hora || '', // HH:MM:SS
        estado: r.estado,
        pmName: r.pm_name,
        pmEmail: r.pm_email
      }));
      // Sincroniza un espejo local opcional (lectura)
      persistLocal();
    }

    async function upsertToDB(row){
      if(!sb) { return; }
      const payload = {
        id: row.id || undefined,
        cliente: row.cliente,
        objetivo: row.objetivo || null,
        fecha: row.fecha,
        hora: row.hora || null,
        estado: row.estado,
        pm_name: row.pmName || null,
        pm_email: row.pmEmail || null
      };
      const { data, error } = await sb.from(DB_TABLE).upsert(payload).select().single();
      if(error){ console.error('DB upsert error', error); return; }
      // devuelve id asignado por la BD
      row.id = data.id;
    }

    async function deleteAllDB(){
      if(!sb) { return; }
      const { error } = await sb.from(DB_TABLE).delete().neq('id', 0); // borra todo
      if(error){ console.error('DB deleteAll error', error); }
    }

    // ===== Filtros y render =====
    function getFilteredRows(){
      const {pm, estado, desde, hasta} = state.filters;
      return state.rows.filter(r => {
        let ok = true;
        if(pm) ok = ok && (r.pmEmail === pm);
        if(estado) ok = ok && r.estado === estado;
        if(desde) ok = ok && r.fecha >= desde;
        if(hasta) ok = ok && r.fecha <= hasta;
        return ok;
      }).sort((a,b)=> (a.fecha + (a.hora||'')) > (b.fecha + (b.hora||'')) ? 1 : -1);
    }

    function renderTable(){
      const rows = getFilteredRows();
      visitsBody.innerHTML='';
      rows.forEach(r => {
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${escapeHtml(r.cliente)}</td><td>${r.fecha}</td><td>${(r.hora||'').toString().slice(0,5)}</td><td>${escapeHtml(r.objetivo||'')}</td><td>${escapeHtml(r.pmName||'')}</td><td><span class="badge status-${r.estado}">${r.estado}</span></td>`;
        visitsBody.appendChild(tr);
      });
    }

    function renderCalendar(){
      const calendarEl=document.getElementById('calendar');
      calendar=new FullCalendar.Calendar(calendarEl,{
        initialView:'dayGridMonth',
        locale:'es',
        selectable:true,
        headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,timeGridDay'},
        dateClick: info => openDialog({fecha:info.dateStr}),
        eventClick: info => {
          const e = info.event;
          const idx = Number(e.extendedProps.index);
          openDialog(state.rows[idx], idx);
        },
        events: []
      });
      calendar.render();
      addEventsFromState();
    }

    function addEventsFromState(){
      if(!calendar) return;
      const rows = getFilteredRows();
      calendar.removeAllEvents();
      rows.forEach((r,idx)=>{
        calendar.addEvent({
          title: r.cliente + (r.objetivo? ' - '+r.objetivo:'') + (r.pmName? ' ('+r.pmName+')':''),
          start: r.fecha + (r.hora? 'T'+r.hora:''),
          allDay: !r.hora,
          index: idx
        });
      });
    }

    function rerenderCalendar(){ addEventsFromState(); }

    function openDialog(data={}, index=null){
      state.editIndex = index;
      document.getElementById('dlgTitle').textContent = index==null ? 'Nueva visita' : 'Editar visita';
      document.getElementById('cliente').value = data.cliente||'';
      document.getElementById('objetivo').value = data.objetivo||'';
      document.getElementById('fecha').value = data.fecha||'';
      document.getElementById('hora').value = (data.hora||'').toString().slice(0,5);
      document.getElementById('estado').value = data.estado||'Pendiente';
      const pmSel = document.getElementById('pm');
      if(data.pmEmail){ pmSel.value = data.pmEmail; } else { pmSel.selectedIndex = 0; }
      dlg.showModal();
    }

    function closeDialog(){ dlg.close(); form.reset(); state.editIndex=null; }

    // ===== Eventos UI =====
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const pmSel = document.getElementById('pm');
      const base = state.editIndex==null ? {} : state.rows[state.editIndex];
      const row = {
        ...base,
        cliente: document.getElementById('cliente').value.trim(),
        objetivo: document.getElementById('objetivo').value.trim(),
        fecha: document.getElementById('fecha').value,
        hora: document.getElementById('hora').value,
        estado: document.getElementById('estado').value,
        pmName: pmSel.options[pmSel.selectedIndex]?.text || '',
        pmEmail: pmSel.value || ''
      };
      if(!row.cliente || !row.fecha){ alert('Completa Cliente y Fecha'); return; }

      // Inserta/actualiza en BD
      await upsertToDB(row);

      // Refleja en memoria y local
      if(state.editIndex==null){ state.rows.push(row); } else { state.rows[state.editIndex]=row; }
      persistLocal();
      renderTable(); rerenderCalendar(); closeDialog();
    });

    document.getElementById('btnApplyFilters').addEventListener('click', (e)=>{ e.preventDefault();
      state.filters.pm = fPM.value; state.filters.estado = fEstado.value; state.filters.desde = fDesde.value; state.filters.hasta = fHasta.value; renderTable(); rerenderCalendar(); });
    document.getElementById('btnClearFilters').addEventListener('click', (e)=>{ e.preventDefault(); fPM.value=''; fEstado.value=''; fDesde.value=''; fHasta.value=''; state.filters={pm:'',estado:'',desde:'',hasta:''}; renderTable(); rerenderCalendar(); });
    document.getElementById('btnCancel').addEventListener('click', closeDialog);
    document.getElementById('dlgClose').addEventListener('click', closeDialog);
    document.getElementById('btnPrint').addEventListener('click', ()=> window.print());

    btnNew.addEventListener('click', ()=> openDialog());

    document.getElementById('btnClearAll').addEventListener('click', async ()=>{
      if(confirm('¬øEliminar todas las visitas de la base de datos?')){
        await deleteAllDB();
        state.rows = []; persistLocal(); renderTable(); rerenderCalendar();
      }
    });

    // CSV export/import (a BD)
    document.getElementById('btnExport').addEventListener('click', ()=>{
      if(state.rows.length===0){ alert('No hay datos para exportar.'); return; }
      const headers=['Cliente','Fecha','Hora','Objetivo','PM','PM_Email','Estado'];
      const lines=[headers.join(',')].concat(state.rows.map(r=>[r.cliente,r.fecha,r.hora||'',r.objetivo||'',r.pmName||'',r.pmEmail||'',r.estado].map(csvEsc).join(',')));
      const blob=new Blob(["\uFEFF"+lines.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='plan_visitas.csv'; a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', async (e)=>{
      const f=e.target.files[0]; if(!f) return; const rd=new FileReader();
      rd.onload=async ()=>{ try{
        const rows=parseCSV(rd.result.toString());
        // Mapea columnas y realiza upsert masivo
        const mapped = rows.map(r=>({
          cliente:r.Cliente, fecha:r.Fecha, hora:r.Hora||null, objetivo:r.Objetivo||null,
          pm_name:r.PM||null, pm_email:r.PM_Email||null, estado:r.Estado||'Pendiente'
        }));
        if(sb){
          const { error } = await sb.from(DB_TABLE).upsert(mapped);
          if(error) throw error;
        }
        await loadFromDB(); renderTable(); rerenderCalendar(); e.target.value='';
      }catch(err){ alert('No se pudo importar el CSV.'); console.error(err);} };
      rd.readAsText(f,'utf-8');
    });

    // ===== Inicio =====
    (async function init(){
      await loadFromDB();
      renderTable();
      renderCalendar();
    })();
  </script>

  <!-- ====================
       INSTRUCCIONES (leer y quitar si deseas)
       1) Crea cuenta gratuita en https://supabase.com (plan Free)
       2) Crea un proyecto y copia la URL y la anon key (Project Settings ‚Üí API)
       3) En SQL Editor, ejecuta lo siguiente para la tabla y las pol√≠ticas:

          create table if not exists public.visits (
            id uuid primary key default gen_random_uuid(),
            cliente text not null,
            objetivo text,
            fecha date not null,
            hora time,
            estado text not null default 'Pendiente',
            pm_name text,
            pm_email text,
            created_at timestamptz not null default now()
          );

          -- Habilita RLS
          alter table public.visits enable row level security;

          -- Pol√≠tica abierta para demo (lectura/escritura p√∫blica con anon)
          create policy "visits_select_anon" on public.visits for select using (true);
          create policy "visits_insert_anon" on public.visits for insert with check (true);
          create policy "visits_update_anon" on public.visits for update using (true) with check (true);
          create policy "visits_delete_anon" on public.visits for delete using (true);

          -- Si no tienes la extensi√≥n pgcrypto para gen_random_uuid():
          create extension if not exists pgcrypto;

       4) Pega SUPABASE_URL y SUPABASE_ANON en las constantes de arriba y ¬°listo!

       Seguridad: Para producci√≥n, crea Auth (email/password o SSO) y ajusta las pol√≠ticas RLS
       para permitir que todos vean y solo ciertos usuarios editen. Esta demo deja la tabla abierta.
  ==================== -->
</body>
</html>
